<html>
<head>
    <title></title>
    <script src="engine.js"></script>
    <script>
        /// <reference path = "engine.js" />
        var selectedTable = undefined;

        var testDoc = {
            type: "document",
            args: [
/*            {
                type: "native",
                name: ["alert "],
                "native": alert,
				hasSideEffects:true,
                args: [
                {
                    type: "native",
                    name: ["", " + "],
                    "native": add,
                    args: [
                        {
                            type: "native",
                            name: ["", " + "],
                            "native": add,
                            args: [
                                {
                                    type: "literal",
                                    literal: 77
                                },
                                {
                                    type: "literal",
                                    literal: 88
                                }
                            ]
                        },
                        {
                            type: "native",
                            name: ["", " + "],
                            "native": add,
                            args: [
                                {
                                    type: "literal",
                                    literal: 55
                                },
                                {
                                    type: "literal",
                                    literal: 66
                                }
                            ]
                        }
                    ]
                }]
            }*/
            ]
        };

        var paletteEntries = {
            type: "document",
            args: [
            {
                type: "declareBlockTemplate",
                name: ["declare ", " returns "],
				run: false,
                args: [
					{
                        type: "functionDeclare",
                        name: ["function"],
						args:[
							{
								type: "varDeclare",
								name: ["arg"],
								local: true,
							},
						],
                    },
					{
						type: "literal",
						literal: ""
					},
                ]
            },
			{
                type: "declareBlockTemplate",
                name: ["declare ", " = "],
				run: false,
                args: [
					{
						type: "varDeclarePlaceholder",
						name: ["constant"],
						local: true,
						mutable:false,
                    },
					{
						type: "literal",
						literal: ""
					},
                ]
            },
			{
                type: "declareBlockTemplate",
                name: ["declare ", " = "],
				run: false,
                args: [
					{
						type: "varDeclarePlaceholder",
						name: ["variable"],
						local: true,
						mutable:true,
                    },
					{
						type: "literal",
						literal: ""
					},
                ]
            },
            {
                type: "nativeTemplate",
                name: ["alert "],
                "native": alert,
				hasSideEffects:true,
                args: [{ type: "literal", literal: "Hello" }]
            },
            {
                type: "nativeTemplate",
                native: function(entry, value){ entry.scope[entry.key] = value; },
                name: ["set ", " = "],
				lvalue: [true, false],
				hasSideEffects:true,
				args: [
                    createEmptyVariableNode(),
					createLiteralNode(0),
                ]
            },
			{
                type: "nativeTemplate",
                native: ask,
                name: ["ask ", " and wait"],
				hasSideEffects: true,
                args: [
                    {
                        type: "literal",
                        literal: "What's your name?"
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " + "],
                "native": add,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " - "],
                "native": sub,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " * "],
                "native": mul,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " / "],
                "native": div,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["pick random from ", " to "],
                "native": rand,
                args: [
                    {
                        type: "literal",
                        literal: 1
                    },
                    {
                        type: "literal",
                        literal: 10
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " < "],
                "native": lt,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " = "],
                native: eq,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["", " > "],
                "native": gt,
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
			{
                type: "nativeTemplate",
                native: function(cond, then, els){ if(run(cond)){ return run(then)} else { return run(els)} },
                name: ["if ", " then ", " else "],
				run: false,
				args: [
					createLiteralNode(0),
					createLiteralNode(0),
					createLiteralNode(0),
                ]
            },
			{
                type: "nativeTemplate",
                native: function(cond, body){ while(run(cond)){ run(body) }; },
                name: ["while ", " do "],
				run: false,
				args: [
					createLiteralNode(0),
					createLiteralNode(0),
                ]
            },
			{
                type: "nativeTemplate",
                native: function(...args){ return args; },
                name: ["list "],
				varArgs: true,
				args: [
					createLiteralNode(0),
                ]
            },
            {
                type: "nativeTemplate",
                name: ["element ", " from "],
                "native": function(idx, list){ return list[idx]; },
                args: [
                    {
                        type: "literal",
                        literal: ""
                    },
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["length of "],
                "native": function(list){ return list.length; },
                args: [
                    {
                        type: "literal",
                        literal: ""
                    }
                ]
            },
            {
                type: "nativeTemplate",
                name: ["list ", " add "],
                "native": function(entry, v){ entry.scope[entry.key].push(v); },
				lvalue: [true, false],
				hasSideEffects:true,
                args: [
                    createEmptyVariableNode(),
					createLiteralNode(0),
                ]
            }
		]};
		
		function ScopeEntry(name, value)
		{
			this.name = name;
			this._value = value;
		}
		
		ScopeEntry.prototype = {
			get value() {
				return this._value;
			},
			
			set value(v) {
				this._value = v;
				if(this.domNode !== undefined)
				{
					this.domNode.textBox.value = v;
				}
			},
		};
		
		var localscope = [
			new ScopeEntry("length", 15)
		];
		
		var contextMenuLayer;
		var contextMenuStack = [];

        function addParents(tree)
		{
            function addParentsRec(current, parent)
			{
                current.parent = parent;
                if (current.args !== undefined)
				{
                    for (var Idx = 0; Idx < current.args.length; ++Idx)
					{
                        addParentsRec(current.args[Idx], current);
                    }
                }
            };

            addParentsRec(tree, undefined);
        }

        function onclick_tableId(cell)
		{
            if (selectedTable != undefined)
			{
                // restore default settings
                selectedTable.className = "sctable";
                selectedTable.draggable = false;
                var headerElement = selectedTable.firstChild.firstChild;
                while (headerElement !== null) {
                    if (headerElement.nodeName === "TD") {
                        headerElement.draggable = true;
                    }
                    headerElement = headerElement.nextSibling;
                }
            }
            selectedTable = merge(cell.parentNode.parentNode,
                {
                    className: "sctable_moving",
                    draggable: true
                });

            var headerElement = selectedTable.firstChild.firstChild;
            while (headerElement !== null)
			{
                if (headerElement.nodeName === "TD")
				{
                    headerElement.draggable = false;
                }
                headerElement = headerElement.nextSibling;
            }
        }

        /*document.addEventListener("dragover", function (event)
        {
            event.preventDefault();
        });

        document.addEventListener("drop", function (event)
        {
            event.preventDefault();
        /*    if (event.target.className == "droptarget")
            {
                document.getElementById("demo").style.color = "";
                event.target.style.border = "";
                var data = event.dataTransfer.getData("Text");
                event.target.appendChild(document.getElementById(data));
            }* /
        });*/

        function onload_init()
		{
            var scratchArea = document.getElementById("scratch_area");
			displayScratchArea();
            scratchArea.ondrop = placeDrop;
            scratchArea.ondragover = allowDrop;

            var paletteArea = document.getElementById("palette_area");
            displayWholePage(paletteEntries, paletteArea);
            paletteArea.ondrop = deleteDrop;
            paletteArea.ondragover = allowDrop;
			
			var dataArea = document.getElementById("data_area");
			displayData(localscope, dataArea);

			contextMenuLayer = document.getElementById("context_menu_layer");
        }

		function displayScratchArea()
		{
			var scratchArea = document.getElementById("scratch_area");
            displayWholePage(testDoc, scratchArea); // redisplay
		}
		
        function displayWholePage(node, rootElement)
		{
            addParents(node);

            removeAllChildren(rootElement);
            rootElement.appendChild(representScratchNode(node));
        }
		
		function displayData(scope, rootElement)
		{
			removeAllChildren(rootElement);
			for(var Idx = 0; Idx < scope.length; ++Idx)
			{
				rootElement.appendChild(representScopeEntry(scope[Idx]));
			}
		}

        function removeAllChildren(element)
		{
            while (element.firstChild !== null)
			{
                element.removeChild(element.firstChild);
            }
        }

        function representScratchNode(scratchNode)
		{
            var newElement;
            switch (scratchNode.type)
			{
                case "document":
                    newElement = document.createElement("DIV");
                    for (var Idx = 0; Idx < scratchNode.args.length; ++Idx)
					{
                        var containerDiv = document.createElement("DIV");
                        containerDiv.appendChild(representScratchNode(scratchNode.args[Idx]));
                        newElement.appendChild(containerDiv);
                    }
                    break;

                case "native":
				case "nativeTemplate":
				case "functionCall":
				case "getvar":
				case "refvar":
				case "declareBlock":
				case "declareBlockTemplate":
					var className;
					switch(scratchNode.type)
					{
						case "declareBlock":
						case "declareBlockTemplate":
							className = "declareBlock";
							break;
						case "refvar":
							className = "mutableNativeNode";
							break;
						case "getvar":
							className = "nativeLeaf";
						default:
							if(scratchNode.hasSideEffects)
								className = "commandNode";
							else if(scratchNode.args === undefined || scratchNode.args.length === 0)
								className = "nativeLeaf";
							else
								className = "nativeNode";
							break;
					}
					
					newElement = merge(document.createElement("DIV"),
					{
						className: className,
						draggable: true,
						ondragstart: drag,
						ondragover: dragOverElement(className+" draggedOverBorder"),
						ondragleave: dragLeaveElement(className),
					});
						
					var template = scratchNode;
					if(scratchNode.template !== undefined)
						template = scratchNode.template;

					newElement.appendChild( document.createTextNode(template.name[0]) );

					if(scratchNode.args !== undefined && scratchNode.args.length > 0)
					{
						newElement.appendChild( document.createTextNode(" ") );
						for(var Idx = 0; Idx < scratchNode.args.length; ++Idx)
						{
							newElement.appendChild( representScratchNode(scratchNode.args[Idx]) );
							if(template.name[Idx+1] !== undefined)
							{
								newElement.appendChild( document.createTextNode(template.name[Idx+1]) );
							}
						}
					}
										
					if(template.varArgs && scratchNode.type !== "nativeTemplate")
					{
						createContextMenu(newElement, [
							contextMenu_AddArgument(scratchNode),
							contextMenu_RemoveArgument(scratchNode),
						]);
					}
					
                    break;
                case "literal":
                    newElement = merge(document.createElement("INPUT"),
                        {
                            type: 'text',
                            className: 'numberField',
                            value: scratchNode.literal,
                            size: 3,
                            onchange: function () {
                                var $t = parseFloat(this.value);
								if(isNaN($t))
									this.scratchNode.literal = this.value;
								else
									this.scratchNode.literal = $t;
                                this.size = this.value.length > 6 ? 20 : 3;
                            },
                            onkeyup: function () {
                                this.size = this.value.length > 6 ? 20 : 3;
                            },
							draggable: true,
                            ondragstart: cancelDrag,
							ondragover: dragOverElement("numberField draggedOverField"),
							ondragleave: dragLeaveElement("numberField"),
                        });
                    break;
					
				case "variableSlot":
                    newElement = merge(document.createElement("DIV"),
						{
							className: 'variableField',
						});

					newElement.appendChild( document.createTextNode("??") );
					break;
					
				case "varDeclarePlaceholder":
                    newElement = merge(document.createElement("DIV"),
						{
							className: scratchNode.mutable?'mutableTemplateFieldLeaf':'templateFieldLeaf',
						});
						
					newElement.appendChild( document.createTextNode(scratchNode.name) );
					break;
					
				case "functionImplement":
					newElement = representImplementationNode(scratchNode);
					break;
				case "functionDeclare":
				case "varDeclare":
					if(g_expandedNode === scratchNode)
					{
						newElement = merge(document.createElement("DIV"),
							{
								className: 'templateField',
							});
						var nameDiv = document.createElement("DIV");
						nameDiv.appendChild( createEditableSpan( scratchNode.name[0], function(text){ scratchNode.name[0] = text; } ));
						newElement.appendChild(nameDiv);
						
						createContextMenu(nameDiv, [
							contextMenu_AddParameterDecl(scratchNode),
							contextMenu_CollapseParameters(scratchNode),
						]);
						
						if(scratchNode.args !== undefined)
						{							
							for(var Idx = 0; Idx < scratchNode.args.length; ++Idx)
							{
								var argsDiv = document.createElement("DIV");
								argsDiv.appendChild( document.createTextNode("*") );
								
								if(Idx > 0)
								{
									var nameText = scratchNode.name[Idx];
									if(nameText === undefined) {nameText = " ";}
									
									var editableSpan = createEditableSpan(nameText, function(index){ return function(text){ scratchNode.name[index] = text; } }(Idx) );
									editableSpan.style.minWidth = 20;

									argsDiv.appendChild(editableSpan);
								}
								argsDiv.appendChild( document.createTextNode(" ") );
								
								newElement.appendChild(argsDiv);
								
								argsDiv.appendChild( representScratchNode(scratchNode.args[Idx]) );
							}
						}
					}
					else
					{
						newElement = representDeclarationNode(scratchNode);
					}
					break;
            }

			switch(scratchNode.type)
			{
				case "nativeTemplate":
				case "functionDeclare":
				case "functionParamDeclare":
				case "declareBlockTemplate":
					newElement.isTemplate = true;
					break;
				case "varDeclare":
					if(g_expandedNode === scratchNode.parent)
					{
						newElement.isEditableTemplate = true;
					}
					else
					{
						newElement.isTemplate = true;
					}
					break;
				default:
					break;
			}
            newElement.scratchNode = scratchNode;
            return newElement;
        }
		
		function representScopeEntry(scopeEntry)
		{
			var newElement = merge(document.createElement("DIV"),
				{
					className: "scopeEntry",
					draggable: true,
					ondragstart: drag,
					scopeEntry: scopeEntry,
					scratchNode: {
						type: "nativeTemplate",
						scopeEntry: scopeEntry,
						text: scopeEntry.name,
						args:[],
						"native": function(){ return scopeEntry.value; },
						"nativeLValue": function(){ return { scope:scopeEntry, key:"value" }; },
					}
				});

			newElement.appendChild( document.createTextNode(scopeEntry.name) );
				
			var textBox = merge(document.createElement("INPUT"),
				{
					type: 'text',
					className: 'numberField',
					value: scopeEntry.value,
					scopeEntry: scopeEntry,
					size: 3,
					onchange: function () {
						var $t;
						this.scopeEntry.value = (($t = parseInt(this.value)) ? $t : this.value);
						this.size = this.value.length > 6 ? 20 : 3;
					},
					onkeyup: function () {
						this.size = this.value.length > 6 ? 20 : 3;
					}
				});

			newElement.appendChild(textBox);
			newElement.textBox = textBox;
			scopeEntry.domNode = newElement;
			return newElement;
		}
		
		function representDeclarationNode(scratchNode)
		{
			var draggable = true;
			if(scratchNode.parent !== undefined)
			{
				if(scratchNode.parent.type === "declareBlockTemplate")
				{
					// placeholders in the library are just there to look pretty
					var newNode = merge(document.createElement("DIV"),
					{
						className: 'templateField',
					});
					newNode.appendChild(document.createTextNode(scratchNode.name[0]));
					return newNode;
				}
				else if(scratchNode.parent.type === "functionDeclare" &&
					scratchNode.parent.parent !== undefined &&
					scratchNode.parent.parent.type === "functionDeclare")
				{
					// a parameter to a function argument can only be renamed, not dragged
					draggable = false;
				}
			}
		
			var newNode = merge(document.createElement("DIV"),
			{
				draggable: draggable,
				ondragstart: drag,
			});

			var editableSpan = createEditableSpan( scratchNode.name[0], function(text){ scratchNode.name[0] = text; } );
			newNode.appendChild(editableSpan);
			
			if(scratchNode.args === undefined || scratchNode.args.length === 0)
			{
				newNode.className = scratchNode.mutable?"mutableTemplateFieldLeaf": "templateFieldLeaf";
			}
			else if(scratchNode.args !== undefined)
			{
				if(scratchNode.parent.type === 'functionDeclare' && scratchNode.type === 'functionDeclare')
				{
					newNode.className = 'functionTemplate';
				}
				else
				{
					newNode.className = 'templateField';
				}

				newNode.appendChild( document.createTextNode(" ") );
				for(var Idx = 0; Idx < scratchNode.args.length; ++Idx)
				{
					newNode.appendChild( representScratchNode(scratchNode.args[Idx]) );
					
					var nameText = scratchNode.name[Idx+1];
					if(nameText === undefined) nameText = "";
					
					if(nameText !== "")
					{
						newNode.appendChild( document.createTextNode(nameText) );
					}
				}
			}
			
			switch(scratchNode.type)
			{
				case "functionDeclare":
				{	
					createContextMenu(newNode, [
						contextMenu_AddParameterDecl(scratchNode),
						contextMenu_ExpandParameters(scratchNode),
					]);
				}
				break;

				case "functionParamDeclare":
				{	
					createContextMenu(newNode, [
						contextMenu_AddParameterDecl(scratchNode),
					]);
				}
				break;
			}
			return newNode;
		}

		function representImplementationNode(scratchNode)
		{
			var newNode;
			newNode = merge(document.createElement("DIV"),
				{
					className: 'functionImplement'
				});

			newNode.appendChild(document.createTextNode(scratchNode.name[0]));
			
			newNode.appendChild( document.createTextNode(" ") );
			for(var Idx = 0; Idx < scratchNode.args.length; ++Idx)
			{
				newNode.appendChild( representScratchNode(scratchNode.args[Idx]) );
				
				var nameText = scratchNode.name[Idx+1];
				if(nameText === undefined) nameText = "";
				
				if(nameText !== "")
				{
					newNode.appendChild( document.createTextNode(nameText) );
				}
				else if(Idx === scratchNode.args.length-2)
				{
					newNode.appendChild( document.createTextNode(" returns ") );
				}
			}

			return newNode;
		}
		
		function createEditableSpan(text, onEdit)
		{
			var result = merge(document.createElement("SPAN"),
				{
					contentEditable: false,
					onblur: function()
					{
						this.contentEditable = false;
					},
					onclick: function()
					{
						if(this.contentEditable === "true")
						{
							this.contentEditable = false;
							window.getSelection().removeAllRanges();
						}
						else
						{
							this.contentEditable = true;
							this.focus();
							selectElementContents(this);
						}
					},
					
					oninput: function(){ onEdit(this.innerText); }
				});
			result.appendChild( document.createTextNode(text) );
			return result;
		}
		
		function createContextMenu(element, items)
		{
			var contextMenuSpan = merge(document.createElement("SPAN"),
			{
				onclick:function()
				{
					showContextMenu(this, items);
				},
			});
			contextMenuSpan.appendChild( document.createTextNode("▼") );
			element.appendChild(contextMenuSpan);
		}
		
		function contextMenu_AddParameterDecl(scratchNode)
		{
			var addParam = function()
			{
				scratchNode.args.push({
					type:"varDeclare",
					name:["arg"+(scratchNode.args.length+1)],
					local:true
				});
				displayScratchArea();
			};
		
			return {
				text:"Add Parameter",
				submenu:[
					{text:"Value", action:addParam},
					{text:"Function", action:function()
						{
							scratchNode.args.push({
								type:"functionDeclare",
								name:["action"+(scratchNode.args.length+1)],
								local:true,
								hasSideEffects:true,
								args:[{
									type:"varDeclare",
									name:["arg"],
									local:true,
									args:[]
								}]
							});
							displayScratchArea();
						}
					},
				],
				action:addParam
			};
		}
		
		function contextMenu_ExpandParameters(scratchNode)
		{
			return {
				text:"Expand Parameters",
				action:function()
				{
					g_expandedNode = scratchNode;
					displayScratchArea();
				}
			};
		}
		
		function contextMenu_CollapseParameters(scratchNode)
		{
			return {
				text:"Collapse Parameters",
				action:function()
				{
					g_expandedNode = undefined;
					displayScratchArea();
				}
			};
		}
		
		function contextMenu_AddArgument(scratchNode)
		{
			return {
				text:"Add",
				action:function()
				{
					scratchNode.args.push({
						type:"literal",
						literal:""
					});
					displayScratchArea();
				}
			};
		}

		function contextMenu_RemoveArgument(scratchNode)
		{
			return {
				text:"Remove",
				action:function()
				{
					scratchNode.args.pop();
					displayScratchArea();
				}
			};
		}

        var g_draggingElement;
		var g_expandedNode;
		var g_draggedOverElement = undefined;

        function drag(ev)
		{
            g_draggingElement = ev.target;
        }
		
		function cancelDrag(ev)
		{
			ev.preventDefault();
        }
		
		function dragOverElement(className)
		{
			return function()
			{
				if(g_draggedOverElement !== undefined && g_draggedOverElement !== this)
				{
					if(hasAncestor(g_draggedOverElement, this))
						return;

					g_draggedOverElement.ondragleave();
				}

				g_draggedOverElement = this;
				this.className = className;
			};
		}

		function dragLeaveElement(className)
		{
			return function()
			{
				if(g_draggedOverElement === this)
					g_draggedOverElement = undefined;

				this.className = className;
			};
		}
		
		function hasAncestor(element, ancestor)
		{
			while(element !== null)
			{
				element = element.parentElement;
				if(element === ancestor)
					return true;
			}
			
			return false;
		}

        function getRoot(node)
		{
            while (node.parent !== undefined)
                node = node.parent;

            return node;
        }

        function cloneNode(node, clonedParent)
		{
            checkTypes([node], ['object']);
            var result = {};
            
			switch(node.type)
			{
				case "nativeTemplate":
					result.type = "native";
					break;
				case "functionDeclare":
					if(clonedParent === undefined)
					{
						result.type = "functionCall";
						result.template = node;
						resolvingTemplate = true;
					}
					else if(clonedParent.type === "functionCall")
					{
						result.type = "functionImplement";
						result.template = node;
					}
					else
					{
						result.type = "functionDeclare";
					}
					result.template = node;
					break;
				case "declareBlockTemplate":
					result.type = "declareBlock";
					break;
				case "varDeclarePlaceholder":
				case "varDeclare":
					//is this a parameter in a function declaration, and we're dragging out a function call from it?
					if(clonedParent !== undefined)
					{
						if(clonedParent.type === "functionCall")
						{
							return { type:"literal", literal:"" };
						}
						else
						{
							result.type = "varDeclare";
						}
					}
					else if(node.mutable)
					{
						result.type = "refvar";
						result.template = node;
					}
					else
					{
						result.type = "getvar";
						result.template = node;
					}
					break;
				default:
					result.type = node.type;
					break;
			}

			for (var key in node)
			{
                if (result.hasOwnProperty(key) || key === "parent")
                    continue;
                var value = node[key];
                result[key] = isArray(value) ? value.map(function (v) {
                    return typeof v !== 'object' ? v : cloneNode(v, result);
                }) : value;
            }
			
			if(result.type === "functionImplement")
			{
				result.args.push({ type:"literal", literal:"" });
			}
			
            return result;
        }

        function placeDrop(ev)
		{
            if (g_draggingElement === undefined)
				return;

			if(g_draggingElement.scratchNode !== undefined)
			{
                var draggingNode = g_draggingElement.scratchNode;
                var targetNode = ev.target.scratchNode;
                var draggingRoot = getRoot(draggingNode);
				
				if(g_draggingElement.isEditableTemplate)
				{
					// we're reordering or removing function parameters
					if(targetNode === undefined)
					{
						var draggedArgIdx = getParentArgIndex(draggingNode);
						draggingNode.parent.args.splice(draggedArgIdx, 1);
						displayScratchArea();
					}
					else if(targetNode.parent === draggingNode.parent)
					{
						var draggedArgIdx = getParentArgIndex(draggingNode);
						draggingNode.parent.args.splice(draggedArgIdx, 1);
						var targetArgIdx = getParentArgIndex(targetNode);
						targetNode.parent.args.splice(targetArgIdx, 0, draggingNode);
						displayScratchArea();
					}
					else if(targetNode === draggingNode.parent)
					{
						var draggedArgIdx = getParentArgIndex(draggingNode);
						draggingNode.parent.args.splice(draggedArgIdx, 1);
						targetNode.parent.args.push(draggingNode);
						displayScratchArea();
					}
					return;
				}
				
				switch(targetNode !== undefined ? targetNode.type: "")
				{
					// can't drag anything onto templates
					case "nativeTemplate":
					case "functionDeclare":
					case "functionDeclarePlaceholder":
					case "declareBlockTemplate":
					case "varDeclarePlaceholder":
						return;
					case "varDeclare":
						if(draggingNode.type === "varDeclare" && targetNode.parent === draggingNode.parent)
						{
							var draggedArgIdx = getParentArgIndex(draggingNode);
							draggingNode.parent.args.splice(draggedArgIdx, 1);
							var targetArgIdx = getParentArgIndex(targetNode);
							targetNode.parent.args.splice(targetArgIdx, 0, draggingNode);
							displayScratchArea();
						}
						return;
				}

				if(g_draggingElement.isTemplate)
				{
					// dragged a template, so clone it
					draggingNode = cloneNode(draggingNode);
                }

                if (targetNode === undefined)
				{
                    // dragged a node into nowhere, add it to the root doc
                    if (draggingNode.parent !== testDoc)
					{
                        dragAwayNode(draggingNode);

                        testDoc.args.push(draggingNode);
						displayScratchArea();
                    }
                }
                else if (targetNode.parent !== undefined && !isAncestorOfNode(draggingNode, targetNode))
				{
                    dragAwayNode(draggingNode);

                    var targetArgIdx = getParentArgIndex(targetNode);

                    var replacedNode = targetNode.parent.args[targetArgIdx];					
                    targetNode.parent.args[targetArgIdx] = draggingNode;

                    if (replacedNode !== undefined && replacedNode.type !== "literal" && replacedNode.type !== "variableSlot")
					{
                        testDoc.args.push(replacedNode);
                    }
					displayScratchArea();
                }

                g_draggingElement = undefined;
            }
        }
	
        function dragAwayElement(element)
		{
			var draggingNode = element.scratchNode;
			if(element.isTemplate)
			{
				if(draggingNode.type === "varDeclare" && draggingNode.parent.type === "functionDeclare")
				{
					// remove function argument
					var draggedArgIdx = getParentArgIndex(draggingNode);
					draggingNode.parent.args.splice(draggedArgIdx, 1);
					displayScratchArea();
				}
				return;
			}
				
			dragAwayNode(element.scratchNode);
		}

        function dragAwayNode(node)
		{
            if (node.parent === undefined)
                return;
			
            var draggedArgIdx = getParentArgIndex(node);
            if (node.parent === testDoc)
			{
                node.parent.args.splice(draggedArgIdx, 1);
            }
            else if(node.parent.lvalue !== undefined && node.parent.lvalue[draggedArgIdx])
			{
                node.parent.args[draggedArgIdx] = createEmptyVariableNode();
			}
			else
			{
                node.parent.args[draggedArgIdx] = createLiteralNode(0);
            }
        }

        function isAncestorOfNode(ancestor, node)
		{
            do if (ancestor === node)
                return true;
            while ((node = node.parent) !== undefined);

            return false;
        }

        function createLiteralNode(value)
		{
            return {
                type: "literal",
                literal: value
            };
        }

		function createEmptyVariableNode()
		{
            return {
                type: "variableSlot",
                literal: ""
            };
        }

        function getParentArgIndex(targetNode)
		{
            if (!targetNode.parent) return undefined;
            var index = targetNode.parent.args.indexOf(targetNode);
            return index === -1 ? undefined : index;
        }

        function allowDrop(ev)
		{
            ev.preventDefault();
        }

        function deleteDrop(ev)
		{
            dragAwayElement(g_draggingElement);
			displayScratchArea();
        }

        function onclick_Run()
		{
            var compiled = compile(
                {
                    globalVariables: [],
                    events: [{
                        name: 'greenflag',
                        data: [],
                        body: testDoc.args
                    }]
                }
            );
            runProgram(compiled);
        }
		
		function onclick_AddVariable()
		{
			localscope.push({name:"var"+localscope.length, type:"int", value:0});
			
			var dataArea = document.getElementById("data_area");
			displayData(localscope, dataArea);
		}
		
		function selectElementContents(el)
		{
			var range = document.createRange();
			range.selectNodeContents(el);
			var sel = window.getSelection();
			sel.removeAllRanges();
			sel.addRange(range);
		}
		
		function showContextMenu(fromElement, items)
		{
			removeAllChildren(contextMenuLayer);
			contextMenuStack = [];
			
			var contextMenu = merge(document.createElement("DIV"), {
				className:"contextMenu",
			});
			var rect = fromElement.getBoundingClientRect();
			contextMenu.style.top = rect.bottom;
			contextMenu.style.left = rect.left;
			
			contextMenuLayer.appendChild(contextMenu);
			contextMenuStack.push(contextMenu);

			addMenuItems(contextMenu, items);

			setTimeout(function(){
				document.addEventListener("click", hideContextMenu);
			}, 0);
		}
		
		function addMenuItems(contextMenu, items)
		{
			for(var Idx = 0; Idx < items.length; ++Idx)
			{
				var item = items[Idx];
				
				var contextMenuItem = merge(document.createElement("DIV"), {
					className:"contextMenuItem",
					onclick:item.action
				});
				contextMenuItem.appendChild( document.createTextNode(item.text) );
				contextMenuItem.parentMenu = contextMenu;
				contextMenu.appendChild(contextMenuItem);
				
				if(item.submenu !== undefined)
				{
					contextMenuItem.appendChild( document.createTextNode(" ►") );
					contextMenuItem.onmouseover = function(itemElement, submenu){
						return function(){ showSubmenu(itemElement, submenu); }
					} (contextMenuItem, item.submenu);
				}
				else
				{
					contextMenuItem.onmouseover = function(){ closeSubmenuTreeUnder(contextMenu); }
				}
			}
		}
		
		function showSubmenu(parentElement, submenuItems)
		{
			for(var Idx = 0; Idx < contextMenuStack.length; ++Idx)
			{
				if(contextMenuStack[Idx] === parentElement.parentMenu)
				{
					var targetLength = Idx+1;
					while(contextMenuStack.length > targetLength)
					{
						contextMenuLayer.removeChild(contextMenuStack.pop());
					}
				}
			}
		
			var subMenu = merge(document.createElement("DIV"),
			{
				className: 'contextMenu',
				draggable: true,
				ondragstart: drag,
			});
			contextMenuLayer.appendChild(subMenu);
			contextMenuStack.push(subMenu);
			
			var rect = parentElement.getBoundingClientRect();
			subMenu.style.top = rect.top;
			subMenu.style.left = rect.right+1;
			
			parentElement.onmouseout = function(ev)
			{
				var rect = parentElement.getBoundingClientRect();
				if(ev.clientX < rect.right)
				{
					closeSubmenuTree(subMenu);
				}
				parentElement.onmouseout = undefined;
			};
			
			addMenuItems(subMenu, submenuItems);
		}

		function closeSubmenuTreeUnder(menu)
		{
			closeSubmenuTreeOffset(menu, 1);
		}

		function closeSubmenuTree(menu)
		{
			closeSubmenuTreeOffset(menu, 0);
		}
		
		function closeSubmenuTreeOffset(menu, offset)
		{
			for(var Idx = 0; Idx < contextMenuStack.length; ++Idx)
			{
				if(contextMenuStack[Idx] === menu)
				{
					var targetLength = Idx+offset;
					while(contextMenuStack.length > targetLength)
					{
						contextMenuLayer.removeChild(contextMenuStack.pop());
					}
					return;
				}
			}
		}
		
		function hideContextMenu()
		{
			removeAllChildren(contextMenuLayer);
			contextMenuStack = [];
			document.removeEventListener("click", hideContextMenu);
		}
		
    </script>
    <style>
        #palette_area {
            height: 600px;
            display: table-cell;
            background-color: beige;
        }

        .scratch_area {
            background-color: #AADDAA;
            height: 600px;
            width: 600px;
            padding: 5px;
            float: left;
        }

		#data_area {
            height: 600px;
            display: table-cell;
            background-color: #FFAAAA;
        }

        .tableId {
            background-color: orange;
            border: outset;
            border-radius: 6px;
            padding-top: 1px;
            padding-bottom: 1px;
            padding-left: 4px;
            padding-right: 4px;
            cursor: pointer;
        }

        .tableHead {
            background-color: #DDDDDD;
            border-bottom: solid;
            border-right: solid;
            border-width: 1px;
            cursor: pointer;
        }

        .tableLhs {
            background-color: #DDDDDD;
            border-bottom: solid;
            border-right: solid;
            border-width: 1px;
            cursor: pointer;
            text-align: right;
        }

        .tableCell {
            border-bottom: solid;
            border-right: solid;
            border-width: 1px;
            border-color: #AAAAAA;
        }

        .sctable {
            position: absolute;
        }

        .sctable_moving {
            position: absolute;
            border: dotted;
        }

		.scopeEntry {
            background-color: #FFAAAA;
            padding-top: 1px;
            padding-bottom: 1px;
            padding-left: 4px;
            padding-right: 4px;
            cursor: pointer;
        }
		
		.nativeNode, .nativeLeaf, .declareBlock, .scopeNode, .valueNode, .commandNode, .mutableNativeNode {
            border: outset;
			border-radius:6px;
			padding-top:0px;
			padding-bottom:0px;
			padding-left:4px;
			padding-right:4px;
			cursor:pointer;
			display:inline-block;
			color: #000000;
		}

		/* color scheme idea:
			rvalue: blue, lvalue: orange, type: green.
			Functions are lighter versions -
			rvalue: sky blue, lvalue: cream, type function: pale green.
			Commands are redder versions -
			rvalue: violet, lvalue: red.
			(no commands return types, but they would be brown I guess.)
			Pattern matches?
		*/
        .nativeNode, .declareBlock {
            border-color: #DDEEFF; /*#FFCC66;*/
            background-color: #CCCCFF; /*#FFA500;*/
        }

		.mutableNativeNode {
            border-color: #FF8822;
            background-color: #FF5500;
        }

        .commandNode {
            border-color: #FFCC66;
            background-color: #FFA500;
        }
		
		.nativeLeaf{
			border-color:#AACCFF;
			background-color:#55A5FF;
		}

		.scopeNode{
			border-color:#FF6611;
			background-color:#FF5500;
		}

        .valueNode {
            border-color: #B060B0;
            background-color: #800080;
            color: white;
        }
		
		.declareBlock {
            background-color: #554411;
			border-color: #665544;
            color: white;
		}

        .numberField {
            background-color: white;
            border: inset;
            border-width: 1px;
            border-radius: 2px;
            padding-top: 1px;
            padding-bottom: 1px;
            padding-left: 4px;
            padding-right: 4px;
            display: inline-block;
        }

        .variableField {
            background-color: #FF5500;
            border: inset;
            border-width: 1px;
            border-radius: 2px;
            padding-top: 1px;
            padding-bottom: 1px;
            padding-left: 4px;
            padding-right: 4px;
			text-align: center;
			vertical-align: bottom;
			width:20px;
			height:15px;
            display: inline-block;
        }
		
		.templateField, .templateFieldLeaf, .mutableTemplateFieldLeaf {
            background-color: #CCCCFF; /*#FFA500;*/
			border-color: #DDEEFF; /*#FFCC66;*/
            border: inset;
            border-width: 1px;
            border-radius: 3px;
            padding-top: 0px;
            padding-bottom: 0px;
            padding-left: 2px;
            padding-right: 2px;
			font-weight: bold;
            display: inline-block;
			color: #000000;
        }
		
		.templateFieldLeaf {
			border-color: #AACCFF;
            background-color: #55A5FF;
            padding-left: 4px;
            padding-right: 4px;
		}

		.mutableTemplateFieldLeaf {
            background-color: #FF5500;
			border-color: #FF9999;
            padding-left: 4px;
            padding-right: 4px;
		}
		
		.functionImplement, .functionTemplate {
            border-color: #FFA500;
            background-color: #FFA500;
			border-style: solid;
			border-width: 1px;
			border-radius: 5px;
            padding-left: 4px;
            padding-right: 4px;
            margin: 1px;
		}
		
		.functionTemplate {
			border-color: #FFCC66;
			border-style: inset;
            display: inline-block;
		}

		#context_menu_layer {
            background-color: transparent;
			position:absolute;
			top:0;
			left:0;
			width:1000;
		}
		
		.contextMenu {
			position:absolute;
			top:0;
			left:0;
            background-color: #BBBBDD;
			border-color: #CCCCDD;
            border: outset;
            border-width: 1px;
            padding-top: 1px;
            padding-bottom: 1px;
            padding-left: 1px;
            padding-right: 1px;
			user-select:none;
		}
		
		.contextMenuItem {
            background-color: #BBBBBB;
            padding-left: 2px;
            padding-right: 2px;
            padding-top: 2px;
            padding-bottom: 2px;
		}
		
		.contextMenuItem:hover {
            background-color: #6699FF;
		}
				
		.draggedOverField {
            border: dashed;
			border-color:red;
			border-width: 1px;
			background-color: pink;
		}
		
		.draggedOverBorder {
			border: dashed;
			border-color:red;
		}
	</style>
</head>
<body onload="onload_init()">
    <table style="width:100%; height:100%">
        <tr>
            <td style="vertical-align:top;">
                <button onclick="onclick_Run()">Run</button>
                <br>
                <div id="palette_area"></div>
            </td>
            <td style="vertical-align:top;">
                <div id="scratch_area" class="scratch_area"></div>
            </td>
            <td style="vertical-align:top;">
                <button onclick="onclick_AddVariable()">Add Variable</button>
                <div id="data_area"></div>
            </td>
        </tr>
    </table>
	<div id="context_menu_layer"></div>

    <!--
    <table class="sctable">
        <tr>
            <td class="tableId" draggable="true" onclick="onclick_tableId(this)">Users</td>
            <td class="tableHead">Name</td>
            <td class="tableHead">Age</td>
        </tr>
        <tr>
            <td class="tableLhs">1</td>
            <td class="tableCell">Sylvia</td>
            <td class="tableCell">35</td>
        </tr>
        <tr>
            <td class="tableLhs">2</td>
            <td class="tableCell">Laurie</td>
            <td class="tableCell">36</td>
        </tr>
    </table>

    <table class="sctable" style="left:200px;">
        <tr>
            <td class="tableId" draggable="true" onclick="onclick_tableId(this)">Products &#8226;</td>
            <td class="tableHead">Name</td>
            <td class="tableHead">Price</td>
        </tr>
        <tr>
            <td class="tableLhs">1</td>
            <td class="tableCell">Hairbrush</td>
            <td class="tableCell">$5.00</td>
        </tr>
        <tr>
            <td class="tableLhs">2</td>
            <td class="tableCell">Shampoo</td>
            <td class="tableCell">$1.40</td>
        </tr>
    </table>
    -->
</body>
</html>